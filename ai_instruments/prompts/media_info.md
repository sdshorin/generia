# Взаимодействие сервисов при загрузке и отображении медиа в Instagram-подобном приложении

Рассмотрим полный процесс взаимодействия всех сервисов для типичных сценариев работы с медиафайлами в вашей микросервисной архитектуре.

## 1. Создание поста с медиа

### Последовательность действий:

```
Клиент → API Gateway → Auth Service → Media Service → S3/MinIO → Post Service → Feed Service
```

1. **Клиент → API Gateway**:
   - Клиент аутентифицируется через API Gateway
   - Клиент запрашивает создание поста с медиа

2. **API Gateway → Auth Service**:
   - API Gateway проверяет токен аутентификации через Auth Service
   - Auth Service подтверждает личность пользователя и его права

3. **API Gateway → Media Service**:
   - Клиент запрашивает предподписанный URL для загрузки медиа
   - Media Service генерирует предподписанный URL для S3/MinIO
   - Клиент получает URL и загружает файл напрямую в S3/MinIO

4. **Клиент → S3/MinIO**:
   - Клиент загружает медиафайл по предподписанному URL
   - S3/MinIO принимает файл и сохраняет его

5. **Клиент → API Gateway → Media Service**:
   - Клиент уведомляет Media Service о завершении загрузки
   - Media Service проверяет наличие файла в S3/MinIO
   - Media Service создает метаданные медиафайла и возвращает ID медиа

6. **Клиент → API Gateway → Post Service**:
   - Клиент отправляет запрос на создание поста с ID медиа и текстом
   - Post Service создает запись поста в базе данных, связывая её с медиа
   - Post Service отправляет событие в Kafka о создании нового поста

7. **Kafka → Feed Service**:
   - Feed Service получает событие о новом посте
   - Feed Service обновляет ленты подписчиков пользователя

## 2. Просмотр поста с медиа

### Последовательность действий:

```
Клиент → API Gateway → Auth Service → Feed Service → Post Service → Media Service → CDN/S3/MinIO → Клиент
```

1. **Клиент → API Gateway**:
   - Клиент аутентифицируется через API Gateway
   - Клиент запрашивает свою ленту или конкретный пост

2. **API Gateway → Auth Service**:
   - API Gateway проверяет токен аутентификации через Auth Service
   - Auth Service подтверждает личность пользователя и его права

3. **API Gateway → Feed Service** (при запросе ленты):
   - Feed Service предоставляет список постов для пользователя
   - Для каждого поста возвращаются базовые данные и ID

4. **API Gateway → Post Service** (при запросе конкретного поста):
   - Post Service возвращает детальную информацию о посте
   - Информация включает ID медиа, связанного с постом

5. **API Gateway → Media Service**:
   - Media Service получает запрос на получение медиа по ID
   - Media Service генерирует URL для доступа к медиа (обычный URL или предподписанный URL для приватных файлов)
   - URL может указывать на CDN, если он настроен

6. **Клиент → CDN/S3/MinIO**:
   - Клиент загружает медиафайл по полученному URL
   - CDN отдает файл из кэша или запрашивает его из S3/MinIO

## 3. Асинхронная обработка медиа

### Последовательность действий:

```
S3/MinIO → Media Service → Kafka → Worker Services → S3/MinIO
```

1. **S3/MinIO → Media Service**:
   - S3/MinIO отправляет событие о новой загрузке (если настроено)
   - Альтернативно, Media Service узнает о новом файле от клиента

2. **Media Service → Kafka**:
   - Media Service публикует событие о новом медиафайле в Kafka
   - Событие содержит информацию о файле и необходимых операциях

3. **Kafka → Worker Services**:
   - Специализированные сервисы обработки (например, Image Processing Service) получают событие
   - Сервисы выполняют необходимую обработку (создание миниатюр, транскодирование видео и т.д.)

4. **Worker Services → S3/MinIO**:
   - Результаты обработки сохраняются в S3/MinIO
   - Создаются производные файлы (миниатюры, версии разного разрешения и т.д.)

5. **Worker Services → Kafka → Media Service**:
   - Сервис обработки отправляет уведомление о завершении обработки
   - Media Service обновляет метаданные медиафайла

## Диаграмма потоков данных

```
┌─────────┐     ┌────────────┐     ┌───────────┐     ┌──────────────┐
│         │     │            │     │           │     │              │
│ Клиент  │◄───►│API Gateway │◄───►│Auth Service│     │ Cache Service│
│         │     │            │     │           │     │              │
└────┬────┘     └──────┬─────┘     └───────────┘     └──────────────┘
     │                 │                                      ▲
     │                 ▼                                      │
     │           ┌──────────┐     ┌────────────┐             │
     │           │          │     │            │             │
     │           │Post Service◄───►│Feed Service│─────────────┘
     │           │          │     │            │
     │           └─────┬────┘     └──────┬─────┘
     │                 │                 │
     │                 │                 │
     │           ┌─────▼─────┐     ┌─────▼────┐
     │           │           │     │          │
     ├───────────►Media Service◄───►│   Kafka  │
     │           │           │     │          │
     │           └─────┬─────┘     └─────┬────┘
     │                 │                 │
     │                 ▼                 ▼
     │           ┌─────────────┐   ┌────────────┐
     │           │             │   │            │
     └───────────►   S3/MinIO  │   │Worker Services
                 │             │   │            │
                 └─────────────┘   └────────────┘
```

## 4. Ключевые моменты взаимодействия

### API Gateway
- Единая точка входа для всех клиентских запросов
- Маршрутизация запросов к соответствующим микросервисам
- Базовая проверка аутентификации токенов

### Auth Service
- Аутентификация и авторизация пользователей
- Выдача и проверка токенов доступа
- Управление правами доступа

### Media Service
- Управление метаданными медиафайлов
- Генерация предподписанных URL для загрузки и скачивания
- Инициация асинхронной обработки медиафайлов

### Post Service
- Создание и управление постами пользователей
- Связывание постов с медиафайлами
- Хранение информации о постах в PostgreSQL

### Feed Service
- Формирование лент контента для пользователей
- Кэширование популярного контента в Redis
- Получение уведомлений о новых постах через Kafka

### S3/MinIO
- Хранение всех медиафайлов
- Предоставление прямого доступа клиентам через предподписанные URL
- Отправка уведомлений о событиях (опционально)

### Kafka
- Асинхронная коммуникация между сервисами
- Обеспечение надежной доставки сообщений
- Возможность масштабирования обработчиков

## 5. Оптимизации для высоких нагрузок

1. **Кэширование в Redis**:
   - Feed Service кэширует ленты пользователей
   - Media Service кэширует метаданные популярных медиафайлов

2. **CDN для доставки медиа**:
   - Размещение CDN перед S3/MinIO
   - Географическое распределение кэша для быстрой доставки

3. **Репликация баз данных**:
   - Master-Slave репликация для PostgreSQL и MongoDB
   - Разделение операций чтения и записи

4. **Шардирование данных**:
   - Распределение данных по нескольким серверам
   - Горизонтальное масштабирование баз данных

5. **Балансировка нагрузки**:
   - Использование Kubernetes Horizontal Pod Autoscaler
   - Динамическое масштабирование микросервисов на основе нагрузки

Такая архитектура обеспечивает высокую масштабируемость, отказоустойчивость и производительность, что особенно важно для приложения типа Instagram, где работа с медиафайлами является ключевой функциональностью.